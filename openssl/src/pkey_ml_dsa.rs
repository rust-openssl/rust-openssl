//! Module-Lattice-Based Digital Signatures.
//!
//! ML-DSA is a signature algorithm that is believed to be secure
//! against adversaries with quantum computers. It has been
//! standardized by NIST as [FIPS 204].
//!
//! [FIPS 204]: https://csrc.nist.gov/pubs/fips/204/final

use crate::error::ErrorStack;
use crate::ossl_param::OsslParamArray;
use crate::pkey::{Private, Public};
use foreign_types::ForeignType;
use std::ffi::CStr;
use std::marker::PhantomData;

// Safety: these all have null terminators.
// We can remove these CStr::from_bytes_with_nul_unchecked calls
// when we upgrade to Rust 1.77+ with literal c"" syntax.
const OSSL_PKEY_PARAM_SEED: &CStr = unsafe { CStr::from_bytes_with_nul_unchecked(b"seed\0") };
const OSSL_PKEY_PARAM_PUB_KEY: &CStr = unsafe { CStr::from_bytes_with_nul_unchecked(b"pub\0") };
const OSSL_PKEY_PARAM_PRIV_KEY: &CStr = unsafe { CStr::from_bytes_with_nul_unchecked(b"priv\0") };
const MLDSA44_CSTR: &CStr = unsafe { CStr::from_bytes_with_nul_unchecked(b"ML-DSA-44\0") };
const MLDSA65_CSTR: &CStr = unsafe { CStr::from_bytes_with_nul_unchecked(b"ML-DSA-65\0") };
const MLDSA87_CSTR: &CStr = unsafe { CStr::from_bytes_with_nul_unchecked(b"ML-DSA-87\0") };

const MLDSA44_STR: &str = "ML-DSA-44";
const MLDSA65_STR: &str = "ML-DSA-65";
const MLDSA87_STR: &str = "ML-DSA-87";

#[derive(Clone, Copy, Debug, PartialEq, Eq, Hash, PartialOrd, Ord)]
pub enum Variant {
    MlDsa44,
    MlDsa65,
    MlDsa87,
}

impl Variant {
    pub(crate) fn as_str(&self) -> &'static str {
        match self {
            Variant::MlDsa44 => MLDSA44_STR,
            Variant::MlDsa65 => MLDSA65_STR,
            Variant::MlDsa87 => MLDSA87_STR,
        }
    }

    pub(crate) fn as_cstr(&self) -> &'static CStr {
        match self {
            Variant::MlDsa44 => MLDSA44_CSTR,
            Variant::MlDsa65 => MLDSA65_CSTR,
            Variant::MlDsa87 => MLDSA87_CSTR,
        }
    }
}

pub struct PKeyMlDsaParams<T> {
    params: OsslParamArray,
    _m: PhantomData<T>,
}

impl<T> PKeyMlDsaParams<T> {
    /// Creates a new `PKeyMlDsaParams` from OSSL_PARAM. Internal.
    pub(crate) unsafe fn from_params_ptr(params: *mut ffi::OSSL_PARAM) -> Self {
        unsafe {
            PKeyMlDsaParams {
                params: OsslParamArray::from_ptr(params),
                _m: PhantomData,
            }
        }
    }
}

impl PKeyMlDsaParams<Public> {
    /// Returns a reference to the public key.
    pub fn public_key(&self) -> Result<&[u8], ErrorStack> {
        self.params.locate_octet_string(OSSL_PKEY_PARAM_PUB_KEY)
    }
}

impl PKeyMlDsaParams<Private> {
    /// Returns the private key seed.
    pub fn private_key_seed(&self) -> Result<&[u8], ErrorStack> {
        self.params.locate_octet_string(OSSL_PKEY_PARAM_SEED)
    }

    /// Returns the private key.
    pub fn private_key(&self) -> Result<&[u8], ErrorStack> {
        self.params.locate_octet_string(OSSL_PKEY_PARAM_PRIV_KEY)
    }
}

#[cfg(test)]
mod tests {

    use super::*;
    use crate::{
        ossl_param::OsslParamBuilder, pkey::PKey, pkey_ctx::PkeyCtx, signature::Signature,
    };

    const OSSL_SIGNATURE_PARAM_MESSAGE_ENCODING: &CStr =
        unsafe { CStr::from_bytes_with_nul_unchecked(b"message-encoding\0") };
    const OSSL_SIGNATURE_PARAM_DETERMINISTIC: &CStr =
        unsafe { CStr::from_bytes_with_nul_unchecked(b"deterministic\0") };

    /// Returns the Private ML-DSA PKey from the provided seed.
    fn new_from_seed(variant: Variant, seed: &[u8]) -> Result<PKey<Private>, ErrorStack> {
        use crate::ossl_param::OsslParamBuilder;

        let mut bld = OsslParamBuilder::new()?;
        bld.add_octet_string(OSSL_PKEY_PARAM_SEED, seed)?;
        let mut ctx = PkeyCtx::new_from_name(None, variant.as_str(), None)?;
        ctx.fromdata_init()?;
        let params = bld.to_param()?;
        unsafe {
            let evp = crate::cvt_p(ffi::EVP_PKEY_new())?;
            let pkey = PKey::from_ptr(evp);
            crate::cvt(ffi::EVP_PKEY_fromdata(
                ctx.as_ptr(),
                &mut pkey.as_ptr(),
                ffi::EVP_PKEY_KEYPAIR,
                params.as_ptr(),
            ))?;
            Ok(pkey)
        }
    }

    #[test]
    fn test_generate_ml_dsa_44() {
        test_generate(Variant::MlDsa44);
    }

    #[test]
    fn test_generate_ml_dsa_65() {
        test_generate(Variant::MlDsa65);
    }

    #[test]
    fn test_generate_ml_dsa_87() {
        test_generate(Variant::MlDsa87);
    }

    // Test vector from https://boringssl.googlesource.com/boringssl/+/refs/heads/main/crypto/mldsa/mldsa_nist_keygen_44_tests.txt
    #[test]
    fn test_ml_dsa_nist_keygen_44() {
        let seed = hex::decode("D71361C000F9A7BC99DFB425BCB6BB27C32C36AB444FF3708B2D93B4E66D5B5B")
            .unwrap();
        let correct_pub_key = hex::decode("B845FA2881407A59183071629B08223128116014FB58FF6BB4C8C9FE19CF5B0BD77B16648A344FFE486BC3E3CB5FAB9ABC4CC2F1C34901692BEC5D290D815A6CDF7E9710A3388247A7E0371615507A572C9835E6737BF30B92A796FFF3A10A730C7B550924EB1FB6D56195F02DE6D3746F9F330BEBE990C90C4D676AD415F4268D2D6B548A8BCDF27FDD467E6749C0F87B71E85C2797694772BBA88D4F1AC06C7C0E91786472CD76353708D6BBC5C28E9DB891C3940E879052D30C8FD10965CBB8EE1BD79B060D37FB839098552AABDD3A57AB1C6A82B0911D1CF148654AA5613B07014B21E4A1182B4A5501671D112F5975FB0C8A2AC45D575DC42F48977FF37FFF421DB27C45E79F8A9472007023DF0B64205CD9F57C02CE9D1F61F2AE24F7139F5641984EE8DF783B9EA43E997C6E19D09E062AFCA56E4F76AAAB8F66600FC78F6AB4F6785690D185816EE35A939458B60324EEFC60E64B11FA0D20317ACB6CB29AA03C775F151672952689FA4F8F838329CB9E6DC9945B6C7ADE4E7B663578F87D3935F2A1522097AD5042A0D990A628510B6103CB242CD8A3AFC1A5ADA52331F4DF461BC1DA51D1D224094E7ABED3D87D98F0D817084780EE80370F397631ECB75D4264B6B5E2E66C0586B5FB743516399165837A0FDFF7C6134F033BFA69C1B2416965C6E578592F40E258CB6DFB29FB8E0F54355B6E24A65F67ABAE3193D007115CC0B9FF94CB911A93B1A76C0E7662F5E2B20139E0159ED929CB932D4895F89A02E55C59DF2DBB8F6E5DD7D5B1F3CEC37B4A9166B381C5440E23E67368CDE0A29D59AA05A3C9BE24A4DC8DD75BE30E82BC635D36AAC66DE880C6701A987D7E05F0F2FF287828BEC30595089D8AB9AA390ED719CAA6E576CDBBE9B184A322E5E2DABB69C23CC696D54FC32FF57001B6B64E2A837F3062D85AEB50B3510F7EDFC34DF38E083D4D9B94FFAB0DE15D73D9AF30B9F31CC4F41C9C24F2D618B2A7C3C4BDFB745D52D3EB54589C8BDA8AC05DAD14EC744505575A0988EEC651C1715439FDFB29923380A43C1A66A86C982A841F11820A6A0E1E2F2FFF5108ECAE51A6AABC9B949226D228FF84C4E5E5D63114D80359C4931E612DCED1838B7D066AC9182CECFA223A21A4C8E155AEFA780373BCC15098AEE40C033AF22F8E7C67A0D2526DA7475E830308C04AED9D32BCCC72E719EE70A8D13F09AC11E26EA237D5CC8F98B5AE0E54F933BD0507942ED900D056FD32F8E6E81777912FD482746029B71CCE3BA69B8FC2D03EB441027C387BC2F95031A0AE7052215EB24B9EA8FB0A961B0F80BFA80D0D6257C1C22B508C5D31B97FCDFE1D1766E8A9C8771932DD598ADB7E717743F45FC571F21E4A516249F81D747F15329790F0F70A0B8E461A4EDF50504AF03F30DDF8A8818E38761E1681D6DDEF0B1DD326B2EC228CE48570F285B49D29D7C2EF37866D5446DF82B8E43B34CB248962A21A9A3946159740F8AEE8E6A16A4EB2B42D143FE2612E05EF4B5E646D813248444556A2A8BF92CE10BADECB6B8A40B080DD42D53346FEFCC4B9B40B1E4998991EC753C95AA2F2A506F311E710B0F1D36C1DCA6644EE6D1D4AE9CEA5666EF4B3E888DBDBB95A77ECFE1E8B477DE7CB07639D682D53020EC14EA6C7DD7E715389D10938429FAB8A068A1466A4CD891359F8074E0F5A142ADD731B87878D985E4FA6ECB3B73D298553418273E9503AA84092C080E5F2902F90F5C59944D24CA0271D11D0D6734606D039550A37FCA2B735850E63F540F2F06B79144B5C4ED2C700BB51C33D265B3D037389C99EFD597642D829DB1EB58643CFCD07F4DEC60B8F727D97BD7C4B59BDA1").unwrap();
        let correct_priv_key = hex::decode("B845FA2881407A59183071629B08223128116014FB58FF6BB4C8C9FE19CF5B0B28965F58D99EE0DE7BFB7840F59F65414289E259E05E8A18D47EC06D7900284AD7A0AE404B93B0498945ABD07638920FC7F8C21282031EECEB0CC48D71FB0AD1CE84B9B3DDD1B3A2A40A15D5BFE0BE23FC4757137C6C8FEB7F8055677BA4AF2814242A9AA0108A4046981800042130A2340A99140E01A931E1300A1A136959486601C111140451244206E4C848A1B80008B2490121901224500B03306112025C144912B30049424D14470E93342023898803238CA1C081CC0411184545C1C20862465210300D52B870A3B004DCA20D4A386511214A01B48C43104809461253068161348618A00920878CA0168682208E41188E52A29021014652184521A42902132ED0B8248816710AB245818480942670DC126C1BC16C4016246236008996108B124E1B3721639225E1C88CA346285A32111C856110B9295990910493651CC40063B810C1184A52900C1CB20D2380090A4021D4188043A64D0835060C98650CB4890C8661D804601C0789D09231D8081100881119294E48B661D8962DD2B04121A1051226860349301A246D99483001200C5CC2840128900A298850340E1804640AB409D1968413196DD91031133689808025E300294A06304448109B429008858902A20D13461110120EDC380C4C468842C004131490C1462248B82D48C80D64346C02348109136842A4211B26511C302A6328688B18609C922C22C9000031058AC08C894430D0142189424C4C106400B64DD2A8246306308BB4289B246EC34262A0C00C0C2050E112444A360AD122320C36014836804C00400C16090C9569A19829110602CC982D08C811498445D20290014942C1062E42C000A2902D9810711A054008058608B2651B36441109402107100B3306D298858148088034305C3844DC266ECA947004394A442841E1464898862D113621221509530826213088DA94804A80601425321295641B02120A92241A4422230624CC12818922600036608A32820CC368A1A04D5B286A110744589851C42831A4064EC0C831CAB46810B669132488840462A3C421E0920523303050B6105942285C3005102286CC260E2226450003928A242C9C024E40B20400148C4A086E4BA6444CC84924464D4946821AA4690A316E21408C22964949044618B72C12B864D1C851C3366E5C2008E3328513198564C2019A4822111300A4B64960C06D1944628C086119B761021570EA732640984F68143D81AB95763698DCD02625A980994C19B7D47626409370F87E45D39B76B6762F7827B2779BA44046F54228A7B1BAC9D8E751AC2DD248521564F81D028AD671DB6A3A5BA3A9463597A519AE0C1DA435FEF7C421CDE7F8483782C4334993192923796DDC3E5803F6C86CF2B37E39BBCB53775E5E9D2BDC65E84395B01AF95C4398503A7E63A8D72F7E9BC58D7655CB86BAFA0B679D1D791F09703F6E4B333A51DFB14B36EAC9A3582F795AFCECC2A67A42C7BC43B447B73EC8B73C9164B2D9EF4F767D607E975738E1D871FE61B7BB9570516959B9E7D8155455FC91590D84BD430921568B718241CCD09C989DDF75F529C4F15818969216EC0FBABEC64F184832BFE428BE44849C42F13CA84A5CE6CA628044CB9DA3FD9CB5EBC776BA0E12683B98253B213B286593779EACC489C985BEB734A7506791BE1A6E6E03B557CFEF2069091B846CDBBB72D36A89FD5C45C7C7FBFAED956EC9D8F3025225D6FEF811B1CC3C6705F056388BBFBBA1FEBF4D072281DC792ADA048216D60D0D6044150909B70A4753336F4D5D3FDB8BACA62946DB28332EC778A76F96577BAF868BF896773C200637495098B0F7749835915348D37641EC74D5A78E565D8100627468B0B5D05C2937618A98E5A12476533CE9D699E0F4F23B3127EE1F8D3CDE3851A94BEB8D606D836D47A9F090581B660FF8EC31E3EF4E45DB530DD88A44D48F84B6BD3CED53BE935EFBCE9930DD83BD004F086A064B3260B7211BA0547CB29E56603B922597B31A30A5FFCBD8A7AD2F3F05372DCEA89048C683164410E56A6E5B7EC2EA6E3B0176DB1EBF9258C97C297E752A202B1B4B02DA47235873CC3E4A376B655779AFFFC9AEF2E30B62BE022AEFF5E34B468507C921A00F1110B2CC1BC99B2EE295A31EAC141AB4D87EDC11D7FEE22A07D69B7008C107EBE47DD2F215D074868C8B929A3DF6614B5E95CC8A52F96C57E1697CEE332F45B1980E6CA372574BDB51825654E6FF31D8E755CFC15B602F46A0570D3BD0D65E43BDE8F792E7D526B3D362FE33638B3870E1C29E1030D3DBA43C3D0DB6E5F501EA3441B709E54FCA1FD3E8654B1A9301AD151A36C8FA1513D0229DE6E94D02A97B9D6F2EE8078A5D1228E783B8FDAC46102A19600C531276B447F3900EF8F723FC3B60D7BBBBDA9F949E4460B2F1103315ACE25B3497CA4B4674A6052304609A16E90D064B0F6A9EAE8D8E4BE38E3B781F9173654E876CE6CC00578171FD9CFDBA5704AF2E60CF84FD02EBEF19AED140287D195023000568E8D908EDEADC76BCA3E7FE8FE1F4B201C2A15603C025A61917AE664B4294C57030AC988D7967364A8BB5857E98218C2943E8CF1CB8C719DACCFAE8F42AA7DDE9B4130170068A9CC86B0552D1DD0A48F63DDB8F8A51B3C0E10F3174A87D18F96533CF0C30C0BE33D37C25CD3EBF8F5F10E66464AC2FB8260BA8B5BD443ABC6AE0D5F89DAA42BC71B2A9BC2D10140B117E32F41353FA1ECEC9DBCCB621350806C4E4EBFC966AA7122D85532728EF26AA40E55E2E1739790FFA157EFA4E2A68DA1EA4C9E3273CDE11DB7DA47220123C40D50B73B8460CD93CB449783EAD8A58F6FF272275A4F6C0437DAF3DF1D8D9617743D9302E73B715AA7CAA139CDD07EDAD2DE7B32B3F11E3C2B6A96D4630632C6D1DE21473A287D42B52D210CD4EF808A998148817BB5083BDAB3A3354B084C5773970B15DA56F755E1F25354EFEFF89FDF4E307998D623CED32C7B9E942B6816A87A233867E2BEB84582FFF61AF612BE6E521AB3005E17D471A5C67A0A927211802CA4A0C2FEDC01A12AF5E8A6E8FF7BD08883AF1D35C2F8570091D9E5FCD9D720644F0A45042443D2FAC309FA7A15B2DBBA1517EA19407B17CAF7E9EA81FBCE42F35A0568B2F70B279E12DA48858F0E0FF0B5CB3A3012308AB83DB627F5439E3A424D83F9E0B7750F2CBD9CA4AFB9BA77765A1EA590CE9E37BC7EABE1EF099765CE59EA74C2776ECCBCEB895997F577733C609B9E853CF03010C5B9CC4E819C041ABF11A9B3866502BF6AC0354E6CE1060D5155E6E5A1AC4FADF73080B20569317F9E118B97C78D7273300E329373E5B64A4181C4AC7B8933F82ADE505D52CDDCEBA373A54D072BC04A8D83273586615ADDC4D6F258BFD75AE94EFD120F20B721A1CAC33FF3446E554D6CFE266B05E4CD44DE77D263A9D347F53B282A7BCB1511DD405A67AC05E7233F5EBB40D38F953AC903F90E96F17A6357EB59ED7900FFD82F54C3043D37F7774A0F4DEFAF65887EB53FE156FB26794982B1249BAD27C89C136097AA2268347FC9C5E5BE79E23C923215353A850E63748E766").unwrap();
        let key = new_from_seed(Variant::MlDsa44, &seed).unwrap();
        assert_eq!(correct_pub_key, key.raw_public_key().unwrap());
        assert_eq!(
            correct_priv_key,
            key.ml_dsa(Variant::MlDsa44)
                .unwrap()
                .unwrap()
                .private_key()
                .unwrap()
        );
    }

    // Test vector from https://boringssl.googlesource.com/boringssl/+/refs/heads/main/crypto/mldsa/mldsa_nist_siggen_44_tests.txt
    #[test]
    fn test_ml_dsa_nist_siggen_44() {
        let sk = hex::decode("611B7B1B3EEC5FADF791720FA1AA37AF831D3E818D378F71D3104EABC56D440C8F77F8A25552C59EBC99F59EBB35E7988C8693A3A7841155742731DB18B2D4E3C622F9627EC0B24C1B11A981CBD630B4A398A1AFF298BCF7E8A4F27EAF2B3080220C502DB7D6B2D35ACA3E74597B69CB2D16F6DBBEF1849D6EF74309472D99DCE2246222B14408C590C310910325860CA20891103222402153162608B13088C6258BB66160400E193722C306011A07680C414842380C123660A1B004C0C62088A085D3124D2335620480012305098B968020C00494087000A821592465D084610A2721004041D10840DA1080CA1001E13028192551539881C2C2110105911BA911C482809822040A445110459098B4250CB78841108114B91160842520268C04188624164CC1022A50466C94A80019A491D908651392400AC5890B1831E3360CCCA031C1241060B89123324490900084087154B665D0A001081531D9244AE4864908C01004448AD0B441213626D1088D089561D9A25104248088A26813B82103C22020804823362949A66CD2047253C0708A0604CC2849122341E480601B326D0BC865C0866D93C6249806201C996DC412920A98288B320882A610C1448421460121C26403930DC1083101903121254E04250CA0845008014E5C224042B64CE232841C03701B1128DAB44C8B260E20170483A45008B368143182DAA009D11604D9A82C90405008924CC2082D90B26D8240654C140D09322183101024B141D186800326619414210804298808260C31245238860A08468C4892814850E1068801B385A130210A28410CA2611A896C8C448C149948C326262183689CA46590244293A85112403163960540C4604814260A370D23254DE4C664E3469290822D19A640410008A32832034440241448631629198680011389A4084D4040241316280C3826E020004A0242E1062904A04C9B1484CB3464E22081A44846D240651B340DD3905108B171DB46069A408DC1806DD2229281446153C69040308050022A21326112C600C1004C5B0661C1B4316394445A0009532025C8C26C229344A134716300094046665C484504B4418C1062590600483225E1943114252C439685231402D8C08C12336D0B41099AC6301339481A372E4312114C0450228984C8022CD29644D42485939830DC984C13B8801A416E10992D42162909908C5C447281A061DA868D00102C1B118120C40D0305810084454AB441DCB47100372C5C4491C1404E61803BABAED3233BBC2835965A0707D8AB6DA689833515082AC4C6B5C9F2DE2637415888F537E42505E9757382057C2C1C964775DB5197740745DD9D8F0390F8F2BAE9535EDFF5502BAD2AA9B6812B1271D1F530EBC8AF0828E19C1358597BFB0FE2B2C0A83A459CD1298C2ABC8064ECDB869342B2519ACFD417615EF3DB10539BF945C453BBB1CBEE42C0693A5E3359E2724ADA665B18790CF874C0D1B5804FF28812BBC56BBB47770E3F65548B24FE5345901794278D11CD26199F74560A9CE946DCB1AF6287B061B4FBAEC412E05FDBD7B458542F086FA7549733ACE05C3A1EB965415932E7DCFBE133690DDE71D2D4F05757066E596345EB3F4E0A7D5BF2D2B43225DABD423BFC132E31FC8033334861B6A1F9D45E9AC5D6F98451B4F89AA9D36934BC9E76F1E66BD9350DF5AABB49378F8C7A15A92FA4431A708B76035D59203718E8F201D8A5BBEE5A004CF43D80A6B6F338453D00555FE66837FB7621CFB83574DE922E5ADB36B0EEBECA883139F8785828DF420A78B729F7C48B0A54999D7263BEA11D24420881404B687D6A1ED3E3267377124241C220E90776006EFDB08687D6C29C08AC802D5829A01D4FBBDA64C5971F30BDD1D50DD4C0BD6B1A48FB58267FA30934002DE597C24ED592832ED3E1611D8E92A66B1F014C1058AAA35814955286C13EFAB794A8D780F03D34040D7C720DE050269A83D22CA822D4A83A14EC7EE08BDC2EA5CDCAECC7CCFCFB08CB8DC6650A45113C07E06ADEB36C661D5970870427C8B2B68521A492355CAEDFBA27DF98611DD9B5C52C7F93059F3C1A5353DC8A971E57A999FE31191B911CC3CC7DCDD3E50F8B7B16795DA36E5A9B9F5764CCC61880999D9A84E1B8B5D1B5117A02F1D6150F99DD1BDD1B535BBEDEF5F98471086A8B807DB1BA8625E6C1E935E3B98A580D6374270076133F326ACEE1BAD894D956142816E9A7C1AC38E7B3FD5E20668C7EBCAF6E7A2E69D522215898ADBA02B6082D7B067176FE4EC357280157E6DBD27DCC0E0B329D720D933C695CC4D7229C280BB3188B7BECC31B7552F497D822A94144184A0A0C3CA68A2B09F355C2C5364065275038B70837A38072BC638792892DC1AC0156F9600AD1E7CD124859F89D0BFAB67ADB997723EFA6D0643046D006BFD5336F3D27AAEBAA5006D26E19795C47E64B332040343979D535E6A7B5348EA5867926269072C92DAD1870A51BA336A4058FAC1967ADAB0AE28C4F4FA71489152B9086A413484FD31FA5868530BA54EC8CE3B8D7F0127C4E643BD65DED8D7CED62FD3E0905C69BB6FA204C392199A6751A9E39A120F9D3037819F28BBCD58EFDD34E2E7CDFFCFAF8E69230370BDEAAC917E78DD3F9EB771483EEC8FC8234CEB92525A1BBAFDB762CE7F944205D15AD928A7E35CF9361F6D7D1EF7A18F198C831CDE930BC90AA25F19336246A1E42427196C6ECD9E8D24C66EEC8B5BC8822295FEB0AB9BCE6CE07662D44EED07CFEF616E18BEE6BC1060EEDD7290FA651EA296C36CD6EAD6CC003311D40DE93561079448EC514D06BFF69815B9DA5D33C3BDD21D2C7632630D801FFCA1084D099225FEBDC24982F206F1DCFAC48D27BE94F8E03F2E73C287080F28F937B5D3298CE96A692F8620277EC41FE229B972E3DB8CB62E6B036A714DB80682581D22236F088D47A0ADD62AE1F6C2989E64E3B0742B3F9259AEA831BDD985FB1C2C678F8C3DB635DBC770E05A7D2364D83DFEABA9AD78CD20625EB50F83164AF953EE4C7B9675077A3977CE20D877C7C2289DC3EA5EC09BEC05FBCE70016DC28678832782880B61947B36E94128CAED07073294E6E6A3E627D2E9E96D9B45E988F7809727E70EEDF404AAAFF9212ADD8DD7A15DFD6BE9D3FEFF9F6BB14B1E0BCD867964604CE5CF406303439C962741410C250309C5498DAC94D749A908CA0786530E34A21181AD1F12A01EBF7C51B588BCE84C0AF130A8BEF97C97FD6A35DC15614CA18B8B9CD9C1081FF8CC09424332D3F6DBE3753948CD6C1894A77C815BF02F96A57DBCA639FBB556FC9A6FFA12BBD9A11FCC8FBEC2557F5EC66D8E06F7D300C40210BE7C1E5C1E3C8BF6B4B24E3BB77BC91C58B493CD8144788C86CE5717DFE4B3EABF33DC63DE26DE2B79517B3D981C51EA1E7D8DD96AF31911197B1797C7B246B8A1ABBBEC7FADF1C1238282191963C7EE1B6162FBFE35CF22262E88F26433A728E62080C83D1B7BC4F092DB4217E3AA648ACBD8A2EAE397B4FD0084CC3391D07695973FCAA49DD0EF644EFF733B9EA293F297E458A532F6461E14A5457ECC61D01435357EA4B61C18758B10580739799C9F69D3AB7E83C6D791822CF").unwrap();
        let message = hex::decode("6C99C711E39EDBF3D42247C433F5B359B94C128AF9B8710B90F990F36DF9854B424EC406EF2EA4CBAAAD9E4679A8C6C3E030A8D527A140309FB640876986A07369C06CF9B8938A6121392C39E911C1D081F97A0E6CEE0CAF477D9A7990C504D6E788573B7847BC5A3E15C3345088AE392FD04D6E5D88FBC0FCE54175EEC976E46D7DC2984BF1A1CF67D79668AF089589F3884207AA7253A920A32C19172432D57D733DE611A2C272D7F8E0B0311C6429FF589A209EF458AA63D43A0D6478C74888C785133294E28EA8E1FB021DB67D5BB09192DE6DBA9D03866F7AF4306A54D3FBFD67AE7815BA923708DB3CF7DE19DEC86B78B84CC346F076FD28EC261996831DF3E1369445C62849DFA1B3AB1400AF5BA10DC7EE71C6DD34FCF43E3D0471D9BB8650F88E757FD532662A12A07AED6B3C66F198F2520A6EEB70AC141BF98F74F1422E987F3C164C390019F8DFB14DE0110F37CD78621BEA1FCF35A4C2B9D64C5E0AC4ED5BFF7B743369FA0E3C293D20146ECDF145EE7EB52F8997FAB049B6340F56211DD1624EDF017DBBF7184B74B6CAE6EE78EDE5A38027954FAADE7CF1EE601359B1E0070603E6BBD6E86EA64B7F347676A238174869080225D765359BD865299D63CAA82D4188278F364EAB824C6DB5DF79545718FE7724590D488E2A76F22594F1F3B83514F0CBF95115BF8D610F6E6690AB8DFDFA1B901CFFBC1D0C8178A4F5DC0C92BAD3468B075251348E9324162A5510A31BE701A183AE8C7BA0F71E4A85A353B2773AC37634C775FF9B9E3EA97B5C142BCCFE48488E84CC7E4A7A527C52ECD3CD3D9F723F81DCA164309025502CD7F5F373713658709052EA794553D52BA58FC0EE6B80714F889C0356B9D9E06F46C39D507E21E2ADC238BE10C2C81EE0F81D0A719596F07546719553E41AA94E63AD426333CE48AF0155855BF5B7C01EF0E7716328431C8826D11EC7D1E3024794B3C883E60EC76A8032B5B11F174664386736E6623D022B302871FB38C9E2B607A4723C1BF88526CED4A02B6F4CB197CC5790B4990AEC06F0E47C6C34963E215E24FED0AF13BCC91CCFF14E44F30FAC95A59177EB40DA0575224FD8C1A1F6BF22E41E7EF9463D5ECF7CF5730F61283FBC3E0E2B5561067CA2F717EC718B45114300B06D33CBEAA3D1E7D8F1BD7CFC8C0EC06407B33AC0D252514AE4EA0E45A76EB3F00CEE37002045C165153358CEECDB01FBB633B3C4340D9EA534EC306536FC0C4A8C69D88E0A7797BB786ECD71F78536144F4541B3B83F5AE47C4278B80039D4E2A44F5423EF5141F8E76B048EF11BE7ACA5309F0BDFB199E08DC8E04B6F7E267CFDBF8CDE31DC45EE5121655220E7AD5C8DE73727B6D2A1312D86FF344092194CBD24769F787493DC5855DE81E2C7678CFD20DD89CAE4A1745E0452C5B89D442FA247198774AA7D6B71020C5746FF36804CB8D284C1BC94D7ACEA49F5DF04DF64AC24811948B345CFA59F465EBC4D5EA7FA32CA9702F1532460623AB979220AB761C8A4A5A730B31650D47615E0F43AE7A4C318EABC402D51CA2949FCCA95A31BB42753F634036A121D87D82F421E4DAA5E054F1D3EBFDEB5BFD9A81243D09D2804B9332E9F98ECF3E056AA9AF5ED2A733B8CCC68BEA7D4E855F38F20F74B68C721CD1D6D9188372B6D0DC512A833A84FFA9F5DAC97BFF62126C5B6D6C45901A56952CE9D3C241399386427B4C9FBAE0CCA537AF8F1D219F06B5992A422709095C28E0E564072A274984E7EB1B0617BB869D94754EEC33477A80E10DF99ABE8B716D81645B417E511A869BC2549C2FF7B392B4F0A27A66DD8D3C26E25834BDE5474C873AFDDB4E4B9E36EFB5C9C083A1634932A77005C7F8987F3FA98D1C97FA4C5582D83D8330F64A34F67A630F4CBCD5A3FEE03EFA4ADA24C4CE2EC1987094B152C5068D6945623971A1CADFFCBD669DF131FDA1495D116C004182E56A67FBFFD6672075EABE1791A0399C1BB6DA6647A3892984606B28834AF13B70E702630DCD71AA52F51A272AC65E1C71D05C6D4BB269F7DD65B96170CA258011E8DDEFBCBB6C68142628B19B669F4DC1EBF2A8CB03245ED6CF2E7A3585C08BB6B59DCA04100864891770601130B6FBEFEEE74145DC35AFB2E20FC51FF58F849639E252527F3CA93D387500B2D730D6844E6FB50A66B59907F04930C935AD0E18234742173B3A4FA3F1A80B754D9FFC22D90ACCF3A7B7DD8C099D9CCED0AAE543FA4E52D353BF8F0B536CC2344192958D0811742AE0F866862AA5C6CA45A300B3EC5D17D32D04344D25ADEC0E3E0831C067D261E16ED19102218FE797FCB4B94F6B003C7362FD6F79F2D30C820A8806024DB38EFEF27BC428D07AD09C8E2720223FF696340A7F83E6D1645D230A617CF21C65CF1CE6E935F14446F2E6E440DE400606E3778A12680CD075D8387D086FC351B4DD5C772629136E1056627C545CA99CCA2B6A34DEB6E9B23643100CA4019AA96F4B40FA6B1A21611856310C2A331385D4EC8E931932ACF5C7C781579A3BC441628CBF77E28E7948CE83677BBCB179C79ABA4878530D362EB32378D462FFE48FD1FDCDA40AAE401D54E1A04F51502940ABF4478ECBA64F2020BA2622ABCE3A6EC2C8DBE5F225BBE239042EA22D66D8E95624A29D6EB748BDD3BFC9B68079217383CDA62A397F655E81A636145422EFEA60B6ABCD41BE3C78F3156557744D887F1882C50D41499001E1F44B9B304BC339173E0418F839F648CAF773D9815742DD317650276BF72874DFA40747F7077066EEE6BEB71AC9E578AA210479BE6FA5F94C4292A0A2B22FC5F51EE2EDA2A079DF71223927408F1FC416F2E98BCD1D83B281B9F870D6E189281DFF463A9E0C6B83BCC187421237B334B369823BDA3DC53B5970EA1E342690F8645B6F03B3D33DA92EB3B99248ED237BD82C9777D9FD737D02FA1DCBB59A476663D02F45B38B515AD16C295DAAC835674C9FB87B9CF4C883A1128F152E0F155801646A7E54701B80A8246CA271148F821F4BDACAE248DACE5E73B5CF1BF97F4E1EAA623A5A44B3176A9AC467C3170756E19B0EAD4D33F2739EB4C30787862B6C8C2FC9887B612D1DE917FED4CC6973118B4D453765FB7DD822ED9B87629C3F697F80C1362882A426D264A8BB0C25513A3C25A3B6EFAAFD5D65F21B1F980F8281D30AFA1D93BF372F0424D25348E3CA4DFD3386E52E0264799E64F56FB1A85BB4C7E19ED6634E6DC31AC1C944149BB26B51DCC7F3B44A7371E16D6BF17241E0CD78F6EF0B4F2C1AB5273B3F918445E6FA6677B1A265C4ABA6FCEE027E0394FE5A534D99FB9618E3137F2DC85FF1606FE3EB6F9670AC441B02F27514324F89E2FF8B30F1E439C269FCF85DE680D79E2C01104207F684898B5531C3BDF005DB6165BE9FFE1D718035E3661AFA27A95CD6B0752A1DB0EFA18F895E73647FA5D007F2858FDDAE5E913B3DF2F7980402D9D8A64363D01DCDE6E59C4E4CBEBCBE38DAFE2F0D0171F31A144537DBA7D53DCDD60D2022A870DE26FF86F1D0B862D67309AACCC5D1E8D6F8C8EBE4AE44CD7DE76CF6BF952FB7D3A7C400F5D86ACC05F8E37CA915CC9AC495925FEA8C289227F55F6C9CBE6BC9FFB2B09960A67E7948A3780D306CB2CD53F9B52B5F1F7A843124A76441B36F7E0623E96BE3109479B0E17F551059C6DF59A1200C3C61FDE91E93B9F5202F5AB7F89857074C1C7E7405E19D4D088927EB19C793AC7B68065D2B357851949A6B4E3E77DE4844D0A6FD5D9B7442CF191E86F54E8F8B7D992FD6D09BD7E309DC1F7A245C6617001D3999531145AB3EE6F90328723DA4048FAAA49EDE557E79FA0EA336A329B82C470922F2840B284DCEB5261A51ED087F562D4E14925E09403C1D6E398369E41D0365058AAD0A21DDCF36FCE795AA97583826A09736CB814C93CFFCA5E8E774BB9CCBC4E94540A5F6B474E013AAAD0038C34721081580D8C84E5ADB42F0E652AF5A9784A5E35AAF693EB6280F93DFA76F12FD8C3B96DF532171A843E4B9D4BCEC8473F3420C23265F72B7D768B24A70923F8527ADC2D7234DE990D909AA1211062EEA5A0461D6F43A9B5F12BA1D4CC24AA1FE06CADAEBC6EE886529006DC1AE8571E4A5749512903650028999C5BBA3129146CB58A792FAD46EEF27021D544D24E8D865B05F63817D46AE6DD5B025DDBF674654AAE6876DE7A504E8169FE6E4BDD849BF936B0A58F5E1A1D0057A9FE94705B6E8F202156EA87BD0CAA859731F26B3D875996CE376403866C0552FD9B87FBD3199BF0D98964DE32C76D15A915CA2070FDF330F96889F65E69AA85351C4F2B21549A6252636831B753FF572DC36D30F13A6F4CC7A84F6E7BED5342BA1C31311F9BD81645BC5BDF4ABAD949D605E4B2AB65A2674E6EC7F96AE01FAD42B3EC919CD55D1275189594A1BDBB8EA2BA4F9A9A96F5A7ADCE077CAD4E2FDB50FD9D05497B03259F7F49A00C4F3555EB75479ABB70AADFB8350DA0FBFC91BEB9A1E3D713A603EA540A0A4576AEDCBA6E03793F0DE87D34D4B0AC4D655830AAC4BF4FE90AA45865B4548238A47F8F648272F92CA7557E088BEE7B6B0BB73ED743AFC406125F2D682F21948BF10823501BB704A430745989C56249380C888649E07440C8CFAB1C87172AA001DF446AD42788F391001F4C847794B12FE74592CF2274CF5CDC4AD80F4905C37DF8D11D7791307D9E57A8BDAFD11C13A8BB668DDBA798D2FDBBFC05A4274B3ABECF1DA18A3C6D9575203968F5718A59E1EF005B84C3939B995C5AE426A69DD8C09D2E3A2AFE02A816EA516E42312F57A023AB42FF0BD8EC0A489F8DE5837FC68E7C9924C92A7C8C31FF675CB09DE338E93F68A66C2C545AC1F765A78A34A87D46010B256A189708CA186F54659AE46FEF2AC18D01C5C89AA1043C603346A4A154CDF6940DD262AACC6A6C35C7F65EFE5899ED2FD5FD4B3C9618F8CCC26472364D364BC3983D09DD59968A4C025EB399D0FFC5A57CF1D7A0918FD116AFBC4057B66E937A902EFE1D3E6A21AC9DDCCB682FA78903BB29A4E0B1DCF2975A47487A432729CEC7E241590380CE21D2897C83262C5EF737847FDF3C5B5DD288029E0D8CF3361960F2958D9FC0873B09E13C0FAE7B99F955D46E794189C05C6FE01A8BBCD7030E982AFFC025B3CCA5FDC169FDB7CDB3A28D5AE59002CF445FB2BA406B6585FC72DFF3DC611E27533B64704886E97317B04C7F11B84AE202758C1EE779EE311546475271CE7DFF229E1330720444D17E99342F9C7BCC43C550C25A6141C6666BD7758D57670D4BDFE9FADDFC0F33C4CFED5FADE05A088AD39FBA7E1A5DE91D7C0F3FA6C914BFDD461489A506A0E37FCFDCB84A5E4276AA7E3EA117455460698E017DDF8E02A18738BEEF560487C974B600D27AC7771EFAEECEA96A9CF79C366B8E2CCF149A7FA2577FC27D3D647927A93D0EE18BCCF7BBD092790EA5F807FA3B2DBB7EAE72B2C5E15D46BF33EE8D68DD4E63A3F2D764270CDB42C75F61009E3EF56BCACD56760DE001B9EFF304961259D96FA59745F0A7F788D4247F92C69B4D3AC3C901E6414CF3FBE9E27E5BB0E100C15926FC4DD902BF6DB10EA36908C9E4384AA3E596D4B3FF6CF27048AF14A897778E875CAAD398DEA860D59A40B9E66B3192930447588E49B6D1D0E5B7AB1F424B4F5C4F73FB76CB4FEB3E251D69D03DD828F3CF57F4E6D4DEFB58219FE7CAE785F30310F7BE932461EAF82E2D6D450EF270CD8192A5364F5F540D0720D8B648196C926378C3AEA5A985748D434629EC0378FA562FE35318567CD3A5633DAAD6783C7456594986EDC7FC65E5BD8CCB33F97145CAAF2F848DC2EBACFEB075A10F6B311A0E7A225D4842A985B3711603027A841A054C1508924AEE79B691C8974DB0D6FCC18F45B8147691E0B7C1CF7C3CA23EC747C252E567F3A9543236D3DA22614783ED52A64042CBDC58327DFB3B9F21B08A6CEBF99433C44E67D08884F1CEC45DB3FD6E9DEC2CABB2405686AAB65A79DCB627A29F7F1544F18B3ED3EBF40C33DEDD3456B57CD7D72C0C6B0ED925508D3ABC7C9024ADA19209B2EB75C459B71D4F30ACFA44953559474C4F41121FF7DD01032CA3125B638BD879EBEAD51F247B4D7D2DD0025191675F8EEC8838790BF59CC094E8D5049A7D00AF4CD5FD94E834D588BA1D14949D95EB02A7ADD9643B244EE87FBE53F904079A4264A0E77C69073CC5ED749D5ADE1C7FE8E2D90C35BF65503352669C24FAC2FC5877F3B01C7ECEDBB4E299C98B57A14F1BE24EBC0060113515BD654A45BB1E5FB600F5FB2D3861369EDA6C46F57A0E999DAB57435979FC4E7320E97EB56CB520298E4499F13FFB7326A735FDAE8456FE3C1BB7FADC48EDFA99E63A29AB87DED3D71BCB4C784AB454A6348B47739634AD49950693408C3CF5DBBDE4A593A1A7B1EEA993E332A09343AEF787183DC8B77E8CCECA5339CC7D6BFEFEEC0C8E634C2D4CC80F2B15C07C14E8405FBDF83AF3C7C97309E0CFF479FED5A9A3AEB57C830EB47F53309081F195AE9A47B3CA5214A2ADA289117201AD9FF8A0AD07562AAF30F32A0F0CDCA06A52847BE17C93729F82B0FAD964AC7639C48C2FD1FBD476108F16DB2569D4C59C87063588ABC539CFC99B817D66BAC60B1994E4D2792771880D26A7B6623C3A032E60942AB78FCEA85EA8F86C5C843637CD3D62A4D8F3FC1B31ED18796E9878C207DE029DF193497B39BCC67543A27526A0154FDAFF42E230FD86BE000B0765251E3C0ED2AAD64C1C1861E7BA24FAA2EFEE2381D4BD96FF16B0AC733EB061DD2177EB6FE591634921E90D71FE5892DD71C56E62E829DC108E22A035F4F836298A60404D026B675D510CAAB0CE2421B6E6A16C75D9EC3D61C4EDDA4DEFB456CB9ADB96200F797FDD3A474F268AA1FD696F8FEA4AC3D104208050C68248A1A5A0323552CC8D9146D1EC2F46DE0CBEB28B6F23EF94558801EDA724B1554A6B0D80265CE43D2D6D8C5F243FD3C5BEAC4432A610ED5522CBFC17727F391AF06B10BFF5048A51F1589C5D791160519F736DE13EA2C15B2B0285B1ADD595C9CB0670859173382B8D83D5676B1958A77DAAEC0749052060F0A2332D3017D5C6BF0776D1B8DEFB8C7BB6E65F03B1FD5E30B5C9839C54D142D728638D00B3E273E3D9186978885D462D895C1A47F889542F33E1128BB89FD871EE5A15242916D7D02D588D062C9211C8543C3C2C4231313E88B7168BB3A03B661E950A9A259A6AC6895C782AC8DCE6496DC62BF406F706F8F43BBF93DC612DA58355E212DB7F8E8030422349292679474BF2ECE146BFBB01A8E519B41A9B08ADA6A2504124313C5AA771B4C2F8AFDE0DF0DA2FE50ED447D497074418D936F1E5051CF8083369227AD8FAB58E935309ECFEF2EB0C800EC99FAA84AB46AB14545CFF4715029CDDFFDBE7AFF3D773F258424EEF2D2D93F12C1A1E95E532450929CBD22880EB9558DC2B207EFEAC28E83490B6F050D4E027858033AB5A79081F59E55C1BC0A7830F339EC40D55187260C5790EEE529EEF85E793CF04FBC9F6A1387596710CEE61427F098F3F5AC7BB54852E74511A4095EF56690A22EA0218C3DE1ED4106DF78F3ACA282EE78E46EEF2B5B907138CD5BF0D8603699C292B6BADF01E8548B9700E8C420126DA4D1BF3C005334E55B008E163678E817C84D13CF0037C028206F325040FB71C6E39279B077FED6D651C6E2AF3A08B3CDF741E445F705F01E82373AD72996BC4DAFC82EFA36DF69AC831AC50046526F5B366BF6FD49218F128CA09FE1AB59E126D738F19963FA29FE4F2D6786188CCF2228D6211ABD8386A15182E460DDA8D9FA90DD9D157488216786B470CFD2E09571116D9A854481F4644E76219551B0A2BFFD4A66BDFDD08FB35B75ACB1E7D527732846117068D734F78B8AE5F43B8CDD237668950A63CDB722DDF35C79898FFF347A5D123ED429289244CA7BB4F36DB6A7FF2641E70991D03A74F5A9816989C1F74FE951E234DC49B84FAEAC33F83C188784B6034B873F2DDC4F470B2DE16840E10E73E11BE53B6DF271C926376E1F8180238AF9AA6AD06B3105372D92CEBB8165E61A5389BC3C027E606E2BF27023136CE9D9E962DE26FB620DAD57E7B9CE609DBB966A718C7B5A0CFDD7C1663268DE6D2ED7513F494D0C409BE0051648F04621D45E5B4E9032344B0932BFEA67874202B3A0E80FF034EC16E4FAB3C0B6634FADB238FD747B920E16D741643563E13B4FA0CB7998AE086AC1D2D6E09E490B9C7D7813CBA2D6E2CE3D3996085B06CEEDC5890CCC42D0B7C18DEBC46739CF37ACDF9C6B0451B6C45C7D0E5A407F8646964A00AFD5F5EB38D87C758277236FDC878A059E919D08FE755F02B77BB934370052F7C70646B1B26E3E080D402C235F248A0374B696998E1116F687A84966E089B5BE9A8284568AFEBC252B2B1A057BE6AAF0D299BDFCCEFD7A5B6CD1B06E8359232755A81A0A156CAD32A35597086C73D84816DCB013A11B56B48CA9C328316F7AB2238689443EC1DD92AD6F0815A1F6F52009E1DE0E1B56BDDEEC48CBF30F4A91BB6B390F51A3D239E4EADB6A5EFA42FD489CD272C31AE5FB22E83D1668B6B87E17BDF258AF4F81F27CB4F8F40689961C02B172BB8D625FBDC3D84EE3A65EEEEDEEE1F3E50645AEBB485FD512C8B9D371CBE3755794A7600BA308AE4E0ADA5251C7C1BDD9FB51FF78090752ED7E02B6622649BDF8A0B6AF9CCBFF46F5CDA7C29B3D53158F1BF9BB89DC160E34342C0AF9FE6BF5CD658FA4ED40C9D3B6DBDB9E174B870978FCB4CE1C1723885593E0669FA622C15BCF1E2236CC0233EA15C2AD547BA2149ACBA11CCFB7B4EB97C670FF74B3E979892009B96011C51A197485D0F2BB4EC683651A891FABF165787E440BE62BB87FE6B568A3423589B544C0C8C12D3D59DBC2571B3D23D03EE1D35BEEE9D709EAE235B30E4C87012DAE924E594E9DC4B167681B15C10DEE22F501EFB46FD41BF39E1F6685EE94B1E6E818291B56C530D187BBB305CAA7FA48CB91A30E7DF945C7BDA52E8F7F5C6D1A6DE5CDBB56B9C498006DADA59BD998CC9ED5E25BBF1FCCA5D37FD51B6D413F25515EDF6364892EADED522E3A9F193782B09BC0BE81CE693D4922447567A1FA2E983CBED36C59585F94641A285D15D817F53CCD577FD76210223BBCCCE8B302077A8B4067312CCF7DF33085E3DE9B7905FF2D3879A964B9E8A3FFF02BD74B901A47F8B3D61BC7452DA676CC29B016001267840888DD59F02E516C2E865A75E4BF5A45F9DEBDD099F7B615C3A9930B44D2765AA1BC0AFA6041C761A6B5BEFB337A105F2504E8766D094003734DABC7800811ED719DF0051E8F5AE2552AD9EA0B29537F61231366CFE7E891C11989CB242C8C809FCA2496F97172387BA86E559B012CFD08CFE41C98A1B7A624E97680C7C69AB37074FB28266C3F453FAC08778E1D7B37AA4181BEDFFCF58AF24B0328C6B1D4842FFC631648C74E9A8EC4198E2CA9E138123D42AC4ABAAFD38B33FF74F6CE09493A35217F459D74ECFDDC798FD080BEE1C009E6CFFB1EB9516BA8A3CDB44C66F853EA1EEB9BA132090D4DBB040C1B8C3EF1A3B16DC66D334920CD207796722AB8D085AB6CCFB0957167BD3D3E57DA1E9C203A4FDEF5478DFF56DEAC3122A9B63A7C12EE2AB7BC793182A6B5446C9A27CCFE43114CBCA6CBBEA0632938F228282CF199C88FA70CEF4186FC85C1062E6270179E694AC6A7C444A28527970DF03E1877BB62CF0A4F5B579DE7F480FB7E43D7FA273920409FE86458D2DEF2648D397B8D713F49F65C9750CEA9EABF0C2D2771879C24377BBB89A705692BA1901A018896F0AE12EFCB642E5EB4EBCA46EDCD74846F1C7615D07C2B841F056A8AF605AA7431ACD991ABE094023A07E7E71DC61AC3A6A7A5C475BA33DA4FCEC05F765866ACC2E80D08911B2C14D0EBC014466B52EF64D0D36CA26D6C4EA57ABCD7F574FE0A2C3E5260A57FA48A044821E1F8E944FC96B5D4645282DB1558B2883595305D02CDC8FD8B67F9A5493535EF8D72B4F12DA052085277CBC319C9BA6A4AC8D9BFF3D5A496FA06F55EAF085C2025ACA4DFB30D411F552432A764C2F480C698BD95656B8C225277FE6ECFB73C852F30961E4A80F2F85E4F2B8007F71EF865B505EB8D7B50BBBAEF50B6059F5E70B43AAE83BB6A35CC843B10C6274711A33E040E2E27E0BFDDB44188804D87337F0542C719AA4CFC73D33DDC4D59150D336FAE3D491E63B37B4448D0B7EE190A508869DB247A81417B4D1C91EB6BF41684F9669957E7CBD8E06741AAEBC84990652948416F9A06AA08F61504E7542ACCFF3498F17E8E23A8C9D9752B248A37905203E61638F34B1DFAD5178B8085A26592663523589B945B4F7134BAB7F18F1071A58A99B9CD332457E19D02D96319FE843D2CA3AAB935DCADAFD36C17A2FF97E7F0FE9A743692CF09EFDC8E7831FB12DD5C6DB789671160300ED05C8C4D0434600544D485F74AE1E4B60ABC1965DB7DFC6FA92BE76F9D2CC57481CF28877514ABF5F443AFF782867845172693D6E4C1CDF8D3F151A03A6458F4CC187DC3370BDCAE930E37A976D0610ADC21C3F621819D0F825F8351C33F042BFD26C7E3814466EB1CB56871C14058575314EF4E80461B83FBFF179DE6F953FB8008E9CF27B42FBB60543C3D15890E99FD7A5B273A8424D6E5FF97A10FC74F58F28DFADFEA45D1AE4C19C2B52D018393A01765365256797AD8D41509626BC53309693EA91CAEB162A0AD7DA40F0DBB0AF90A0CD4FA58B22127178E9BB8725BB9CDD1B2D81C7C9DBCFC6F8F14779092576FCD7BBE159304CC415B15BA6BADC22FB1F54491552AD864C82267FF14F37C3CC1EA497A921DAF126317F2E4E165EF646E9417F3DD5441B9481DCBC4A577D4343007104B0220B3C9F921F596D4107293E71D76F937BC43D2355BAB55D7984468AED70563F9C671D58D4FB021367704E363A35CE9D0830B456B0A1184064119A9432C1DE903E64743F7477C42F1AEEC46DFA1A6F1418794CCB0194A311A791D0992B1C022BDE4950AA49E71654FCB5EB54B2BFD135ABC6B135ECBDDA8F0EBE278ACCC1E50543772DCC4F1ADACAAE3888DB24B1CFCE1C9D5A102245A20C16A0C424B1C48D85900F06828EEED206D7D37B8FC9F02FD3E2D84F5A46761449F9BBBA2220B19D29C852CB5384B2A76BF7A187368F9CC7D0C2E5D64FEE55D75C628B353559CAA75E0A0B2B91C1F2B8B9273DAF1DD277D52FF014ECC810A734F3E38C453D6BCEA8A7BF59AE65CBB8E5AEADE6F72249BAE8A8C9A104027166B8B870F749A6A0669F1F60F9D8BB209ED0F4165D2EC860A5EA2C33E6A30BEE09A09715CE049BADFB0CDCAE57C834E71C8F6DACF20B12FECD877492F6A2AC424D76282DC0D7AF0B7DE6226F2C95E7197D23D593E6586431CE57EC7D0F18931E7B09433FE2B20BF1225304563DE055B90584AB8AC0284B90B60ADFCBC8D25F813D5F50824EEC9E29AE95BC32E81B3CAE22B54F6F9AD17DCC8B912C80DBB987DE86ED727A8E786E54F3465C3EF4D722E28ABB8450B0E56FAF").unwrap();
        let signature = hex::decode("3C893292DE5ECEB98E8DC90DAEBA924D727EEA3E7E9B109FCCB583CC63ECB215589220FA5F52A3AC18E4EB624698241AB7F00932174E610674EC98BACDB2922C386418216E2346EF4B8B26B8EC21F78FE698408C81237CA7E724DF078553C79C225D6D570126F5D1D07F7E72B22D6378C0CD7883B583CA5AAE8173E71B45D8C9C306412FD2DA9BFC6314AF417FEE43EEEB61CBBE93764E987AC98CD36D9E05A67F90A1AF278933C76E01929B6B36DCBC822FF81FAAB6E9D78E6C49ABED9B9429F2A516F4B49195E1E889F484D78330BB2F3E1E582AC8BFA08C84E4B6AB1F7BF5CC44DF0A6977D2C66BC149639C51438B2C4A98958598CAA835FC064F83B735A3DD140689B72A1076EB545AB071E24A8880AB0776C77B72D43462074A8D2E39720B60DB41F26CBBDCFE6CD2185A4164EDCCB76A6499EA85620ED7B7B9ECE60266E0152B230BD3B824FD470A4AEB53EBC8D391139BDE923D485C04AA89C897937C4847043EDE95D9D152F284370D9887160885E913C380145FBD14A27B97C9491AE6E44AE1DAB9202A13E2E70A7C006A06E8437CE0236CC383D0484A47D25629E88C68F137FD406CFA47EBBBAFF6112C3E2E6484814642275173BDFED67AD367634282DC1E155CFF35262F6C8075330D09BAB8F69767EBC700ECD03D1A0032A517BFD62BE24417F3166F06BA66F5F6DA0A4388B18CBED9D505C1663A1443F95B5646A57BFEF351BD5E4DF5E78E2CBDCF43ECC9DC9BF4D8350FB2564928BCEFD9F5616F535E2B3CC27D67D22931F087AAF00A6EC488C6FFB307FBF1FCEDE9B5D6669C9E54FE197E66DA11603584ED96D009C31605DABDD2C419C0B2AE620D3B0B54C046BC4DDC06EAC92E3CA2610D8167CA9F7D7E37BC961E768FDC3F97EF245108C1185507B98B1292857275BB3072996A2E4E9174CC77758CA7851A84D5569BB3494DB39554DB04A12C70E13FA9DD9B50A3A1D3FB18E525A7A9C3E129DB04E559C2C404D3B0258971E1D8BD0E2C4528571D92017754FC66523C0A1C6F7195351371A3FECC4BB7F84F54E097602BDE244BC302C626E6FF7E7FCA56CBB45F17734995955D5A338A839B1DED636E708809E16C12997CE360EFF01D03D6FB2AFA09AC212D97638CB828B1FBFED83F6F8C563B122BADF404365CBE952273FB53D113D1722FD760CB7F3060E5404DBDD06F24A29AB59E39B4460E31D5EA7AE9C302E7F4022226C77C301DCFF18A20B0830ACCD965027CE90659AE43B6842A1C0FAC376D07D775C117FA3DA1AEE8896EF3F13D6F297647034B08E815344D68208EC66F648E78A7BF36FE222050B7CC09A52A272F71EFDCE4A14E420E58EFB38513160ADA616E479FD8371E286EC181293FE66BD1208186E46542AD08DBF17A4A64F7325610B48628EB2AC31364FA834DF27F2F5BE68BE7B6F7600198C4C77E2D829091DA44722D553AC35C5DFEAB882140FF553102CE14557ED72B4310CC8B4A0EE60CF6536048BF94EE89A40AD39F9E6E6E7C9C9BF1D00730F5379AA2C2E1E29FFD75D4DEF518977A93D91B73A145CBB69CB5CF2F30D3816F16C08F891550844E816236EBEAAC077A381709BF1789AA561F2244681159691DD22F102BD487EE620889652362B347782284F6A17EB4F73229E46386240961C1FA02AB0AF02089E177156EE3E01657FCF806C50C973FD072395CD10ADD35DED147D57289714BD5D3E5D503D14B17961C7237EA933F0BE19FDF6105740667846D7F6C310D2F27C1CC0D5D33A41B817E7279CE36881F44C44D9614B694ECD30D1D676B436B0C730B950984543E77BBB1122A311F3D17A75EDC716759490FD045CC955948F23B25C72C9565151181331544716EE47089A11D54E3948EDD9CF22679B35CC4122E1D87DD728AC242315C79A6250C79ECCD111D5CCD30A1DB0A086AD8D68AC0E45164E7AA7B093A8B7DEBA2E40D5B8FBBE6B94A16A430269AB590C5EEE00F2331FF592EB9DE287F40EB5827C02777384DCBC6D6633AD966C19CC6C040FEF372331185266EF5064C044A1B8E08DC3DDC869E285D25017A3B7224CAE23A62647017463D9BB2448B06F2D0E59EF64812EEF86FFF30DDD996925C5E234468A6BB89A88CB59DFCF908AFC3D3A49B1242709474A2CDFB3C641768B4B6C79DD982673606EC3E86EDB6B5B93EF15534D888006ADF25D39AB029521F86B8230B7BA54E0749CE20ABE4CC55C4165A09FE5BDB5CD11A6E83C797D491669D5E8BCF1B1F7F397A04337E4B7F4C252AD0001E550488250D7CEBFA9AAA8F380D5469F8C2F677D42BB41F8B0ABED80EDAAB35804DA2E2ABD68FA663C478F78A37536752E61696F161A7748C4E5115A331FB7D9805ED6E1D0B9A9C42D74E642EB13704BA0C0C26EED9001C36A021C2BD447C9B688944EBEF52B360528FCBCD5E7DB4C261223BD55B53611C805E2A7DC8E3CA9495D5BAF02A77F3783D896088EB393B956B136CD7172D20B8219BFAFD9D060F593E847C6724F7D16446225BFA5582BC5F8F56D723E6471238484412704BE2F75022EC33A8441FA9F7899165859AD7AEEBE4AC22ADDA8CEF206E6580B3FA100F9976C12D3E768E59A212FB9B4BB15AFA618FD45DA50C27EA2CD3AE20CB8D463F54D4BD5FE75F4B69E7C39F988FBAD288C9EF6196C5F5EA8B0B2AD6919D5B72DD005F67847F0B5DAFE9869D738D24C4E022B5FE62B6E12E59ABC0CE2B65F554589DC1210C4C9104975F2832A65ED9E85E22973B3670E883408AC2DBE2BA0398D85B972E86E9C9552C216751DB50B7895B8B3F1CC823536097DEF6171304B43DE798674EF95836FC77DDD9B048DE1E1F7CA2A9BA562EB4AE3CEE09100C64AE2476CBD5D656D48BF8F9BEA751A45C10B00089CC0F1ABC2AF0633EE3181995EB3DD9B99576D8AFDB95D741A7D4C7262066B1F12DA77F69806FCBCF01329DFCEE84748A3C0988D9E90A9E3E3669234535CFE9C3FE86E7900AC2EAB256CF8D67292D712873DE305D5627D7B0E949B408D3476FBD41E0B0780294808FFDB8CED95B7F75DE636EBAD3D3571BC156A37A26095BF71EB1ABF448A0A07C99272A830336CC47657E70C79530E74C167B5045067D8CFCA5411BD86D3710FD2A52016BCAF443812144137EFF33928B1E0E1CD4C2761015AEA83959ED5C0B4E69B4471CBA7776AC0F6E4ED3B40CDDEF30058E35ECAF24F98C8BF1E09BECF3119FB0EDBC0EBFB7E01EFF271D04C176E6D27BFE5738945F4E2586B2EC3073942ACD26A2C2B0E5F8DAC416AF1A0B9E62C755F17FAF78AB4067EAB92035C34D3FE9D08256C96F270322285061777E82889B9EA5A9B1BEC0C1E3FB0810193C6F768587B8CED5F10008162E476CA4B9CEDBEAF0F20910162B333D445671738E9AA9C0C3EAED00000000000000000000000000000000000000131F2C3D").unwrap();

        let key = PKey::private_key_from_raw_bytes_ex(&sk, super::MLDSA44_STR).unwrap();
        let mut algo = Signature::for_ml_dsa(Variant::MlDsa44).unwrap();
        let mut params = OsslParamBuilder::new().unwrap();
        params
            .add_uint(OSSL_SIGNATURE_PARAM_MESSAGE_ENCODING, 0)
            .unwrap();
        params
            .add_uint(OSSL_SIGNATURE_PARAM_DETERMINISTIC, 1)
            .unwrap();

        let mut sig = vec![];
        let mut ctx = PkeyCtx::new(&key).unwrap();
        ctx.sign_message_init_with_params(&mut algo, params.to_param().unwrap())
            .unwrap();
        ctx.sign_to_vec(&message, &mut sig).unwrap();
        assert_eq!(signature, sig);
    }

    fn test_generate(variant: Variant) {
        let key = PKey::generate_ml_dsa(variant).unwrap();

        let mut algo = Signature::for_ml_dsa(variant).unwrap();

        let data = b"Some Crypto Text";
        let bad_data = b"Some Crypto text";

        let mut signature = vec![];
        let mut ctx = PkeyCtx::new(&key).unwrap();
        ctx.sign_message_init(&mut algo).unwrap();
        ctx.sign_to_vec(&data[..], &mut signature).unwrap();

        // Verify good version with the original PKey
        ctx.verify_message_init(&mut algo).unwrap();
        let valid = ctx.verify(&data[..], &signature);
        assert!(matches!(valid, Ok(true)));
        assert!(ErrorStack::get().errors().is_empty());

        // Verify bad version with the original PKey
        ctx.verify_message_init(&mut algo).unwrap();
        let valid = ctx.verify(&bad_data[..], &signature);
        assert!(matches!(valid, Ok(false) | Err(_)));
        assert!(ErrorStack::get().errors().is_empty());

        // Derive a new PKey with only the public bits.
        let key_pub_bytes = &key.raw_public_key().unwrap();
        let key_pub =
            PKey::<Public>::public_key_from_raw_bytes_ex(&key_pub_bytes, variant.as_str()).unwrap();
        let mut ctx = PkeyCtx::new(&key_pub).unwrap();
        let mut algo = Signature::for_ml_dsa(variant).unwrap();

        // Verify good version with the public Pkey
        ctx.verify_message_init(&mut algo).unwrap();
        let valid = ctx.verify(&data[..], &signature);
        assert!(matches!(valid, Ok(true)));
        assert!(ErrorStack::get().errors().is_empty());

        // Verify bad version with the public Pkey
        ctx.verify_message_init(&mut algo).unwrap();
        let valid = ctx.verify(&bad_data[..], &signature);
        assert!(matches!(valid, Ok(false) | Err(_)));
        assert!(ErrorStack::get().errors().is_empty());

        // Derive a new PKEY with the seed.
        let private_params = key.ml_dsa(variant).unwrap().unwrap();
        // Derive a new PKEY from the private seed.
        let key_priv = new_from_seed(variant, private_params.private_key_seed().unwrap()).unwrap();

        // And redo the signature and verification.
        let mut signature = vec![];
        let mut ctx = PkeyCtx::new(&key_priv).unwrap();
        ctx.sign_message_init(&mut algo).unwrap();
        ctx.sign_to_vec(&data[..], &mut signature).unwrap();

        // Verify good version with the public PKey
        ctx.verify_message_init(&mut algo).unwrap();
        let valid = ctx.verify(&data[..], &signature);
        assert!(matches!(valid, Ok(true)));
        assert!(ErrorStack::get().errors().is_empty());
    }
}
